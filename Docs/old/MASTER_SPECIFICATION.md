# 🔴 マスター仕様書 - 相続書類AI-OCRシステム

**⚠️ 重要: このファイルは実装時に必ず参照すること**

## 📌 絶対遵守ルール

### 🚫 禁止事項

1. **ハードコーディング禁止** - すべての設定値は環境変数または設定ファイルで管理
2. **タブ分離UI禁止** - 土地・建物は統一リストで表示
3. **単一登記簿原則** - 1つの登記簿からは1つの不動産のみ抽出

### ✅ 必須事項

1. **プルダウン修正機能** - すべての分類はプルダウンで修正可能
2. **部分失敗時の継続処理** - エラーがあっても処理を継続
3. **エラーログ記録** - どこで失敗したか後から確認可能

---

## 🎯 システム目的

相続税申告に関する書類を自動読み取りし、財産区分別に分類・リネームを行い、財産目録のExcelファイルで取り込めるようにCSVで出力するとともに、リネームしたPDFを生成する。全社員で使うこと、外販することを最終目標としているためWebアプリとして誰でも使えるようにする。

**ターゲットExcel**:

```
C:\Users\iwanaga\社内開発\GAS\相続書類AI-OCR\inheritance-doc-processor\Excel\財産目録 ○○様（更新日）　マクロ ver1.48.00.xlsm
```

---

## 📊 書類種別と抽出データ仕様

### A. 相続財産評価資料（メインシステム）

#### 1. 土地・建物（実装途中）

**対象書類**: 登記簿謄本、名寄帳、固定資産税通知書、評価証明書

**抽出項目**:

- 都道府県（所在地から検索・複数候補時はプルダウン選択）
- 市区町村
- 大字・丁目
- 地番 / 家屋番号
- 登記地目（登記簿より）
- 課税地目（名寄帳等より）
- 持分（相続人情報と連携）
- 地積（名寄帳）
- 敷地権割合（マンションの場合）
- 固定資産税評価額（名寄帳等より）

**統合ロジック**:

1. 地番でマッチング（第一優先）
2. 地積も一致すれば完全一致判定
3. 地積が異なる場合は地番の一致度で判定
4. **重要**: 1つの登記簿 = 1つの不動産

#### 2. 上場株式・投資信託

**抽出項目**: 銘柄名、証券会社、支店名、評価額、株式数/口数

#### 3. その他の出資金

**抽出項目**: 出資先、出資先の所在地、株数/口数、単価、出資額

#### 4. 公社債

**抽出項目**: 銘柄、細目（公債/社債）、額面、利率、評価額

#### 5. 預貯金

**抽出項目**: 金融機関、支店、種類、口座番号、残高、既経過利子（定期預金）

#### 6. 生命保険

**抽出項目**: 保険会社名、証券番号、契約者、被保険者、保険金受取人、受取年月日、保険金、解約返戻金

#### 7. 死亡退職金

**抽出項目**: 勤務先会社名、証券番号、退職手当金の名称、保険金受取人、受取年月日、金額

#### 8. その他財産

**抽出項目**: 細目、利用区分、相手方、評価額

#### 9. 債務

**抽出項目**: 種類、細目、支払先氏名、支払先住所、発生年月日、支払年月日、支払額

#### 10. 葬式費用

**抽出項目**: 内容、支払先氏名、支払先住所、支払年月日、金額

#### 11. 通帳（実装済み・表形式は未実装）

**抽出項目**: 年月日、入金、出金、摘要、残高

### B. 手続き関係書類（サブシステム）

**対象書類**: 戸籍謄本、法定相続情報、印鑑証明書、住民票、戸籍の附票

**処理内容**:

- ファイルリネーム
- 被相続人と相続人、相続開始年月日の抽出
- 相続税2割加算対象者の通知（兄弟姉妹等）

---

## 🔧 実装仕様

### 区分コード体系

```
L: 土地（Land）
B: 建物（Building）
S: 株式（Stock）
D: 預金（Deposit）
T: 通帳（Tsūchō）
I: 生命保険（Insurance）
O: その他財産（Other）
C: 債務（Credit）
F: 葬式費用（Funeral）
P: 手続き書類（Procedure）
R: 退職金（Retirement）
G: 公社債（Government bonds）
U: 不明（Unknown）
```

### ファイル命名規則

```
{区分コード}{連番3桁}_{内容}_{機関名}_{基準日}.pdf

例：
L001_土地登記簿_世田谷区123番地_R05.pdf
B001_建物登記簿_世田谷区456番地_R05.pdf
```

### CSV出力仕様

**形式**: UTF-8 with BOM（Excel互換）
**構造**: 単一シートにすべての財産を統合
**カラム例**:

```csv
区分,細目,所在地,地番/家屋番号,地目,地積/床面積,評価額,持分,備考
土地,宅地,東京都世田谷区○○,123番1,宅地,200.50,25000000,1/1,
建物,居宅,東京都世田谷区○○,123番1,木造2階建,150.25,15000000,1/1,
預金,普通預金,三菱UFJ銀行○○支店,1234567,,5000000,,
```

---

## 👥 相続人管理機能

### 実装方針

1. **手動入力欄**: 相続人の名前を入力可能
2. **自動抽出**: 戸籍謄本・法定相続情報から自動反映
3. **上書き保護**: 既に入力済みの情報は上書きしない
4. **2割加算判定**: 兄弟姉妹等の場合に自動通知

### データ構造

```json
{
  "被相続人": {
    "氏名": "山田太郎",
    "死亡日": "2023-12-31"
  },
  "相続人": [
    {
      "氏名": "山田花子",
      "続柄": "配偶者",
      "法定相続分": "1/2",
      "2割加算": false
    }
  ]
}
```

---

## ⚡ パフォーマンス要件

### バッチ処理

- **ファイル数制限**: 初期実装は10-20ファイルで制限
- **処理順序**: 戸籍・法定相続情報を優先（あれば）
- **エラーリトライ**: 3回（安定性と速度のバランス）
- **部分失敗**: 継続処理し、エラーログに記録

### 並行処理

- **OCR並列数**: 最大10プロセス
- **タイムアウト**: 120秒/ファイル
- **メモリ制限**: 1GB/プロセス

---

## 🔒 セキュリティ要件（Phase 2で実装）

1. 個人情報の暗号化（AES-256）
2. アクセスログの記録
3. データ保持期限の設定（90日）
4. 個人情報保護法準拠

**注**: まずは動作を優先し、Phase 2で実装

---

## 🚀 実装優先順位

### Phase 1: 基本機能完成（現在）

1. 🔲 永続化層（完了）
2. 🔲 エラーハンドリング（完了）
3. 🔲 表形式取引履歴のOCR
4. 🔲 統一リストUI（タブ廃止）
5. 🔲 都道府県選択機能

### Phase 2: 相続人管理

1. 🔲 相続人入力画面
2. 🔲 戸籍からの自動抽出
3. 🔲 法定相続分計算
4. 🔲 2割加算判定

### Phase 3: CSV/Excel連携

1. 🔲 CSV出力最適化
2. 🔲 Excel直接出力（後日仕様確定後）
3. 🔲 マクロ連携

### Phase 4: セキュリティ強化

1. 🔲 暗号化実装
2. 🔲 アクセスログ
3. 🔲 データ保持期限管理

---

## 💻 技術実装方針

### Codex使用時の注意

```python
# 外部記憶の活用
- MASTER_SPECIFICATION.md  # この仕様書（必読）
- implementation_log.md    # 実装ログ
- error_log.md           # エラー記録
- test_cases.md          # テストケース
- test_results.md        # テスト結果記録

# 自律的動作
- タスクキューで処理管理
- 定期的に仕様書を参照
- エラー時は継続処理
- 実装後は自動でテスト実行
- テスト失敗時は自動修正
- 実装完了後はGitHubにプッシュ
```

### 自律的テスト実行（必須）

```python
# テストデータ
test_data_path = "backend/test/"
# - 通帳/: 通帳PDFファイル
# - *.pdf: 名寄帳(nayose)、登記簿(touki)等
# - 理想データ: 期待される抽出結果

# テスト実行フロー
1. 実装完了
2. テストデータでOCR実行
3. 理想データと比較
4. 差異があれば修正
5. 再テスト
6. 全テスト合格でコミット
```

### 設定値管理（ハードコーディング禁止）

```python
# 環境変数
OCR_ENGINE = os.getenv('OCR_ENGINE', 'azure')
MAX_FILES = int(os.getenv('MAX_FILES', '20'))
RETRY_COUNT = int(os.getenv('RETRY_COUNT', '3'))

# 設定ファイル (config.yaml)
document_types:
  land: "土地"
  building: "建物"

classification_codes:
  L: "土地"
  B: "建物"
```

---

## ✅ チェックリスト（実装時確認）

- [ ] ハードコーディングしていないか？
- [ ] すべての分類がプルダウンで修正可能か？
- [ ] 1登記簿=1不動産の原則を守っているか？
- [ ] エラー時も処理を継続するか？
- [ ] エラーログは記録されているか？
- [ ] 地番マッチングロジックは実装されているか？
- [ ] 相続人情報の手動入力・自動抽出両対応か？
- [ ] ファイル数制限（10-20）は実装されているか？
- [ ] CSV出力は実装されているか？
- [ ] **テストを実行して合格したか？（TESTING_GUIDE.md参照）**
- [ ] GitHubにプッシュしたか？

## 🧪 テスト実施方法

詳細なテスト手順は[TESTING_GUIDE.md](./TESTING_GUIDE.md)を参照してください。

### クイックテスト

```bash
# Docker起動
docker compose -f docker-compose-simple.yml up -d --build

# APIテスト
curl http://localhost:8000/

# 自動テスト実行
python3 test_standalone_features.py
python3 test_new_features.py
```

---

## 📝 更新履歴

| 日付       | バージョン | 更新内容                         |
| ---------- | ---------- | -------------------------------- |
| 2025-09-24 | 1.0        | 初版作成、ユーザー要望を完全反映 |

---

**⚠️ 重要**: Codex実装時はこのファイルを必ず最初に読み込み、仕様を確認すること。不明点があれば実装前に確認を取ること。
